<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Trading System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/app.css">
</head>
<body class="bg-gray-50">
    <!-- 导航栏 -->
    <nav class="gradient-bg shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <a href="/" class="text-white text-xl font-bold">
                            <i class="fas fa-chart-line mr-2"></i>
                            Trading System
                        </a>
                    </div>
                    <div class="hidden md:ml-6 md:flex md:space-x-8">
                        <a href="/" class="text-blue-200 font-medium px-3 py-2 rounded-md text-sm">
                            <i class="fas fa-tachometer-alt mr-1"></i>
                            仪表盘
                        </a>
                        <a href="/static/trading.html" class="text-white hover:text-gray-200 px-3 py-2 rounded-md text-sm">
                            <i class="fas fa-exchange-alt mr-1"></i>
                            交易控制
                        </a>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center">
                        <div id="system-status-indicator" class="w-3 h-3 bg-gray-400 rounded-full pulse-dot"></div>
                        <span id="system-status-text" class="text-white text-sm ml-2">连接中...</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主内容区 -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- 快速统计卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- 组合价值卡片 -->
            <div class="bg-white rounded-lg shadow card-hover p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500">组合价值</p>
                        <p id="portfolio-value" class="text-2xl font-bold text-gray-900">$0</p>
                        <p id="portfolio-change" class="text-sm text-gray-600 mt-1">今日: $0 (0%)</p>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-wallet text-3xl text-blue-500"></i>
                    </div>
                </div>
            </div>

            <!-- 持仓数量卡片 -->
            <div class="bg-white rounded-lg shadow card-hover p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500">持仓数量</p>
                        <p id="positions-count" class="text-2xl font-bold text-gray-900">0</p>
                        <p class="text-sm text-gray-600 mt-1">开仓头寸</p>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-chart-pie text-3xl text-green-500"></i>
                    </div>
                </div>
            </div>

            <!-- 日盈亏卡片 -->
            <div class="bg-white rounded-lg shadow card-hover p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500">日盈亏</p>
                        <p id="daily-pnl" class="text-2xl font-bold text-gray-900">$0</p>
                        <p id="daily-pnl-pct" class="text-sm text-gray-600 mt-1">0%</p>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-chart-line text-3xl text-purple-500"></i>
                    </div>
                </div>
            </div>

            <!-- 交易状态卡片 -->
            <div class="bg-white rounded-lg shadow card-hover p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500">交易状态</p>
                        <p id="trading-status" class="text-lg font-bold text-gray-900">未启动</p>
                        <p id="trading-mode" class="text-sm text-gray-600 mt-1">模拟模式</p>
                    </div>
                    <div class="flex-shrink-0">
                        <i id="trading-status-icon" class="fas fa-pause text-3xl text-gray-400"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- 图表区域 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- 组合价值趋势图 -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">组合价值趋势</h3>
                    <div class="flex space-x-2">
                        <button class="time-range-btn text-sm text-gray-500 hover:text-gray-700" data-range="1d">1天</button>
                        <button class="time-range-btn text-sm text-gray-500 hover:text-gray-700" data-range="7d">7天</button>
                        <button class="time-range-btn text-sm text-blue-500 font-medium" data-range="30d">30天</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="portfolio-chart"></canvas>
                </div>
            </div>

            <!-- 系统监控图 -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">系统资源监控</h3>
                <div class="chart-container">
                    <canvas id="system-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- 持仓详情表格 -->
        <div class="bg-white rounded-lg shadow mb-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">当前持仓</h3>
            </div>
            <div class="overflow-x-auto">
                <table id="positions-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">交易对</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">方向</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">数量</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">入场价格</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">当前价格</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">盈亏</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">盈亏%</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody id="positions-tbody" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="8" class="px-6 py-4 text-center text-gray-500">
                                <div class="loading-spinner mx-auto mb-2"></div>
                                <span>加载持仓数据中...</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 最新活动 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- 最新信号 -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">最新交易信号</h3>
                    <button class="text-sm text-blue-500 hover:text-blue-700" onclick="refreshSignals()">
                        <i class="fas fa-refresh mr-1"></i>刷新
                    </button>
                </div>
                <div id="latest-signals" class="space-y-3">
                    <div class="flex items-center justify-between text-sm text-gray-500">
                        <span>加载中...</span>
                    </div>
                </div>
            </div>

            <!-- 系统告警 -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">系统告警</h3>
                    <button class="text-sm text-blue-500 hover:text-blue-700" onclick="refreshAlerts()">
                        <i class="fas fa-refresh mr-1"></i>刷新
                    </button>
                </div>
                <div id="latest-alerts" class="space-y-3">
                    <div class="flex items-center justify-between text-sm text-gray-500">
                        <span>系统运行正常</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 通知区域 -->
    <div id="notification-area" class="fixed top-20 right-4 z-50 space-y-2"></div>

    <!-- JavaScript -->
    <script src="/static/js/api.js"></script>
    <script src="/static/js/dashboard.js"></script>
    <script src="/static/js/realtime.js"></script>

    <script>
        // 页面专用的初始化逻辑
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化时间范围按钮事件
            document.querySelectorAll('.time-range-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // 移除所有按钮的激活状态
                    document.querySelectorAll('.time-range-btn').forEach(b => {
                        b.classList.remove('text-blue-500', 'font-medium');
                        b.classList.add('text-gray-500');
                    });
                    
                    // 激活当前按钮
                    this.classList.add('text-blue-500', 'font-medium');
                    this.classList.remove('text-gray-500');
                    
                    // 更新图表
                    const timeRange = this.getAttribute('data-range');
                    updatePortfolioChart(timeRange);
                });
            });
        });

        // 刷新信号列表
        async function refreshSignals() {
            try {
                await window.dashboard.loadLatestSignals();
                window.dashboard.showNotification('信号数据已刷新', 'success');
            } catch (error) {
                window.dashboard.showNotification('刷新失败', 'error');
            }
        }

        // 刷新告警列表
        async function refreshAlerts() {
            try {
                await window.dashboard.loadLatestAlerts();
                window.dashboard.showNotification('告警数据已刷新', 'success');
            } catch (error) {
                window.dashboard.showNotification('刷新失败', 'error');
            }
        }

        // 更新组合图表
        async function updatePortfolioChart(timeRange) {
            if (!window.dashboard || !window.dashboard.isInitialized) return;
            
            try {
                const days = {
                    '1d': 1,
                    '7d': 7, 
                    '30d': 30
                }[timeRange] || 30;
                
                const history = await window.dashboard.apiClient.getPortfolioHistory(days, '1h');
                if (history.success && history.data && history.data.history) {
                    window.dashboard.updatePortfolioChart(history.data.history);
                }
            } catch (error) {
                console.error('更新图表失败:', error);
            }
        }

        // 平仓操作
        async function closePosition(positionId) {
            if (!confirm('确认平仓这个头寸吗？')) return;
            
            try {
                const result = await window.dashboard.apiClient.closePosition(positionId, 'Manual close from dashboard');
                if (result.success) {
                    window.dashboard.showNotification('平仓成功', 'success');
                    // 刷新持仓数据
                    setTimeout(async () => {
                        await window.dashboard.loadPositions();
                        await window.dashboard.loadPortfolioSummary();
                    }, 1000);
                } else {
                    window.dashboard.showNotification(`平仓失败: ${result.error?.message || '未知错误'}`, 'error');
                }
            } catch (error) {
                console.error('平仓失败:', error);
                window.dashboard.showNotification('平仓失败，请检查网络连接', 'error');
            }
        }
    </script>
</body>
</html>